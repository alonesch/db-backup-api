name: Restore PostgreSQL Backup (Full Clean)

on:
  workflow_dispatch:
    inputs:
      backup_file:
        description: "Nome do arquivo em backups/ a restaurar (ex: backup-2025-12-03_17-46.sql.gz.gpg)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  restore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg

      - name: Restore FULL CLEAN
        env:
          POSTGRES_CONNECTION: ${{ secrets.POSTGRES_CONNECTION }}
          BACKUP_PASSPHRASE: ${{ secrets.BACKUP_PASSPHRASE }}
          BACKUP_FILE: ${{ github.event.inputs.backup_file }}
        run: |
          cd backups

          if [ ! -f "$BACKUP_FILE" ]; then
            echo "Arquivo $BACKUP_FILE não encontrado em backups/"
            exit 1
          fi

          echo "Descriptografando arquivo: $BACKUP_FILE"
          gpg --batch --yes \
            --decrypt \
            --passphrase "$BACKUP_PASSPHRASE" \
            "$BACKUP_FILE" > restore.sql.gz

          echo "Descompactando restore.sql.gz..."
          gunzip -f restore.sql.gz   # gera restore.sql

          echo "Criando novo database (FULL CLEAN)..."

          # Extrai a senha da connection string
          PGPASSWORD=$(echo "$POSTGRES_CONNECTION" | sed -E 's|.*://([^:]+):([^@]+)@.*|\2|')

          # Extrai componentes do POSTGRES_CONNECTION
          HOST=$(echo "$POSTGRES_CONNECTION" | sed -E 's|.*@([^/:]+).*|\1|')
          PORT=$(echo "$POSTGRES_CONNECTION" | sed -E 's|.*:([0-9]+)/.*|\1|')
          USER=$(echo "$POSTGRES_CONNECTION" | sed -E 's|.*://([^:]+):.*|\1|')

          TIMESTAMP=$(date +"%Y_%m_%d_%H_%M")
          NEW_DB="db-barber-restored-$TIMESTAMP"

          echo "Novo database: $NEW_DB"

          # Cria o database limpo
          docker run --rm \
            -e PGPASSWORD="$PGPASSWORD" \
            postgres:18 \
            sh -c "createdb -h $HOST -p $PORT -U $USER $NEW_DB"

          echo "Database criado com sucesso. Iniciando restore..."

          docker run --rm \
            -e PGPASSWORD="$PGPASSWORD" \
            -v \"$(pwd)\":/data \
            postgres:18 \
            sh -c \"psql -h $HOST -p $PORT -U $USER $NEW_DB < /data/restore.sql\"

          echo "Restore FULL CLEAN concluído com sucesso."
