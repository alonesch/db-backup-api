name: Daily PostgreSQL Backup

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download PostgreSQL 18 pg_dump
        run: |
          wget https://ftp.postgresql.org/pub/source/v18.1/postgresql-18.1.tar.gz
          tar -xzf postgresql-18.1.tar.gz
          cd postgresql-18.1
          ./configure --without-readline --without-zlib
          make -C src/bin/pg_dump
          sudo cp src/bin/pg_dump/pg_dump /usr/local/bin
          pg_dump --version

      - name: Run pg_dump
        env:
          POSTGRES_CONNECTION: ${{ secrets.POSTGRES_CONNECTION }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M")
          FILE="backup-$TIMESTAMP.sql"
          mkdir -p backups
          pg_dump "$POSTGRES_CONNECTION" > "backups/$FILE"
          echo "Backup gerado: backups/$FIL
