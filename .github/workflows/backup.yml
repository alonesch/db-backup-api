      - name: Run pg_dump using PostgreSQL 18 Docker image + retention
        env:
          POSTGRES_CONNECTION: ${{ secrets.POSTGRES_CONNECTION }}
          RETENTION_DAYS: ${{ secrets.RETENTION_DAYS }}
        run: |
          mkdir -p backups

          echo "============================="
          echo " INICIANDO ROTINA DE RETENÇÃO"
          echo "Manter últimos $RETENTION_DAYS dias"
          echo "============================="

          # Apaga arquivos antigos (exceto o que será gerado agora)
          OLD_FILES_COUNT=$(find backups -type f -name "backup-*.sql" -mtime +$RETENTION_DAYS | wc -l)

          if [ "$OLD_FILES_COUNT" -gt 0 ]; then
            echo "  Apagando $OLD_FILES_COUNT backups antigos..."
            find backups -type f -name "backup-*.sql" -mtime +$RETENTION_DAYS -print -delete
          else
            echo "Nenhum backup antigo encontrado para remover."
          fi

          echo "============================="
          echo " GERANDO BACKUP NOVO"
          echo "============================="

          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M")
          FILE="backup-$TIMESTAMP.sql"

          docker run --rm \
            -e PGPASSWORD=$(echo "$POSTGRES_CONNECTION" | sed -E 's|.*://([^:]+):([^@]+)@.*|\2|') \
            postgres:18 \
            sh -c "pg_dump \"$POSTGRES_CONNECTION\"" > "backups/$FILE"

          echo "Backup gerado: backups/$FILE"
